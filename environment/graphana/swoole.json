{
  "__inputs": [
    {
      "name": "DS_PROMETHEUS",
      "label": "Prometheus",
      "description": "",
      "type": "datasource",
      "pluginId": "prometheus",
      "pluginName": "Prometheus"
    }
  ],
  "__requires": [
    { "type": "grafana", "id": "grafana", "name": "Grafana", "version": "9.0.0" },
    { "type": "datasource", "id": "prometheus", "name": "Prometheus", "version": "1.0.0" },
    { "type": "panel", "id": "stat", "name": "Stat", "version": "" },
    { "type": "panel", "id": "bargauge", "name": "Bar gauge", "version": "" },
    { "type": "panel", "id": "timeseries", "name": "Time series", "version": "" },
    { "type": "panel", "id": "gauge", "name": "Gauge", "version": "" }
  ],
  "title": "Swoole / ss_* (multi-instance, multi-worker)",
  "uid": "SSWOOLE_MULTI",
  "schemaVersion": 36,
  "style": "dark",
  "editable": true,
  "refresh": "5s",
  "time": { "from": "now-30m", "to": "now" },
  "templating": {
    "list": [
      {
        "name": "job",
        "type": "query",
        "datasource": "${DS_PROMETHEUS}",
        "query": "label_values(ss_http_uptime_seconds, job)",
        "refresh": 1,
        "includeAll": true,
        "multi": true
      },
      {
        "name": "instance",
        "type": "query",
        "datasource": "${DS_PROMETHEUS}",
        "query": "label_values(ss_http_uptime_seconds{job=~\"$job\"}, instance)",
        "refresh": 1,
        "includeAll": true,
        "multi": true
      }
    ]
  },
  "panels": [
    {
      "id": 1, "type": "stat", "title": "Cluster Uptime (min across instances)",
      "gridPos": { "h": 4, "w": 8, "x": 0, "y": 0 },
      "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" },
      "targets": [{ "expr": "min(ss_http_uptime_seconds{job=~\"$job\",instance=~\"$instance\"})", "instant": true, "refId": "A" }],
      "fieldConfig": { "defaults": { "unit": "s" } }
    },
    {
      "id": 2, "type": "stat", "title": "Workers (total across instances)",
      "gridPos": { "h": 4, "w": 8, "x": 8, "y": 0 },
      "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" },
      "targets": [{ "expr": "sum(ss_http_total_workers{job=~\"$job\",instance=~\"$instance\"})", "instant": true, "refId": "A" }]
    },
    {
      "id": 3, "type": "bargauge", "title": "Workers by instance (total / active / idle)",
      "gridPos": { "h": 4, "w": 8, "x": 16, "y": 0 },
      "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" },
      "options": { "displayMode": "lcd" },
      "targets": [
        { "expr": "sum by (instance)(ss_http_total_workers{job=~\"$job\",instance=~\"$instance\"})",  "refId": "A", "legendFormat": "{{instance}} total" },
        { "expr": "sum by (instance)(ss_http_workers_active{job=~\"$job\",instance=~\"$instance\"})", "refId": "B", "legendFormat": "{{instance}} active" },
        { "expr": "sum by (instance)(ss_http_workers_idle{job=~\"$job\",instance=~\"$instance\"})",   "refId": "C", "legendFormat": "{{instance}} idle" }
      ]
    },

    { "type": "row", "title": "Traffic & Coroutines", "gridPos": { "h": 1, "w": 24, "x": 0, "y": 4 }, "collapsed": false, "id": 10 },

    {
      "id": 11, "type": "timeseries", "title": "Requests per minute (cluster total)",
      "gridPos": { "h": 8, "w": 12, "x": 0, "y": 5 },
      "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" },
      "targets": [
        { "expr": "sum(rate(ss_http_request_total{job=~\"$job\",instance=~\"$instance\"}[1m])) * 60", "refId": "A", "legendFormat": "req/min" },
        { "expr": "sum(rate(ss_http_dispatch_total{job=~\"$job\",instance=~\"$instance\"}[1m])) * 60", "refId": "B", "legendFormat": "dispatch/min" }
      ],
      "fieldConfig": { "defaults": { "unit": "ops" } }
    },
    {
      "id": 12, "type": "timeseries", "title": "Requests per minute by instance",
      "gridPos": { "h": 8, "w": 12, "x": 12, "y": 5 },
      "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" },
      "targets": [
        { "expr": "rate(ss_http_request_total{job=~\"$job\",instance=~\"$instance\"}[1m]) * 60", "refId": "A", "legendFormat": "{{instance}} req/min" }
      ],
      "fieldConfig": { "defaults": { "unit": "ops" } }
    },

    {
      "id": 13, "type": "timeseries", "title": "Coroutines (active / peek)",
      "gridPos": { "h": 8, "w": 12, "x": 0, "y": 13 },
      "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" },
      "targets": [
        { "expr": "sum by (instance)(swoole_coroutines{job=~\"$job\",instance=~\"$instance\"})", "refId": "A", "legendFormat": "{{instance}} active" },
        { "expr": "sum by (instance)(swoole_coroutines_peek{job=~\"$job\",instance=~\"$instance\"})", "refId": "B", "legendFormat": "{{instance}} peek" }
      ]
    },
    {
      "id": 14, "type": "timeseries", "title": "Connections (accepted/closed per min, active)",
      "gridPos": { "h": 8, "w": 12, "x": 12, "y": 13 },
      "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" },
      "targets": [
        { "expr": "sum(increase(ss_http_accept_total{job=~\"$job\",instance=~\"$instance\"}[1m]))", "refId": "A", "legendFormat": "accepted/min" },
        { "expr": "sum(increase(ss_http_close_total{job=~\"$job\",instance=~\"$instance\"}[1m]))",  "refId": "B", "legendFormat": "closed/min" },
        { "expr": "sum(ss_http_connections{job=~\"$job\",instance=~\"$instance\"})",                 "refId": "C", "legendFormat": "active total" }
      ]
    },

    { "type": "row", "title": "Latency & Memory", "gridPos": { "h": 1, "w": 24, "x": 0, "y": 21 }, "collapsed": false, "id": 20 },

    {
      "id": 21, "type": "timeseries", "title": "HTTP latency p95 (cluster)",
      "gridPos": { "h": 8, "w": 12, "x": 0, "y": 22 },
      "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" },
      "targets": [
        { "expr": "histogram_quantile(0.95, sum(rate(ss_http_request_duration_seconds_bucket{job=~\"$job\",instance=~\"$instance\"}[5m])) by (le))", "refId": "A", "legendFormat": "p95" }
      ],
      "fieldConfig": { "defaults": { "unit": "s" } }
    },
    {
      "id": 22, "type": "timeseries", "title": "Memory (RSS and per worker)",
      "gridPos": { "h": 8, "w": 12, "x": 12, "y": 22 },
      "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" },
      "targets": [
        { "expr": "sum(proc_memory_bytes{job=~\"$job\",instance=~\"$instance\"})", "refId": "A", "legendFormat": "RSS total" },
        { "expr": "sum(ss_http_memory_per_worker_bytes{job=~\"$job\",instance=~\"$instance\"})", "refId": "B", "legendFormat": "per worker (approx)" }
      ],
      "fieldConfig": { "defaults": { "unit": "bytes" } }
    }
  ],
  "annotations": { "list": [] },
  "links": [],
  "timezone": ""
}