{
  "__inputs": [
    {
      "name": "DS_PROMETHEUS",
      "label": "Prometheus",
      "description": "",
      "type": "datasource",
      "pluginId": "prometheus",
      "pluginName": "Prometheus"
    }
  ],
  "__requires": [
    { "type": "grafana", "id": "grafana", "name": "Grafana", "version": "9.0.0" },
    { "type": "datasource", "id": "prometheus", "name": "Prometheus", "version": "1.0.0" },
    { "type": "panel", "id": "stat", "name": "Stat", "version": "" },
    { "type": "panel", "id": "bargauge", "name": "Bar gauge", "version": "" },
    { "type": "panel", "id": "timeseries", "name": "Time series", "version": "" },
    { "type": "panel", "id": "gauge", "name": "Gauge", "version": "" }
  ],
  "title": "Swoole / ss_* Dashboard (stats())",
  "uid": "SSWOOLE_MAIN",
  "schemaVersion": 36,
  "style": "dark",
  "editable": true,
  "refresh": "5s",
  "time": { "from": "now-30m", "to": "now" },
  "annotations": { "list": [] },
  "panels": [
    {
      "id": 1, "type": "stat", "title": "Uptime",
      "gridPos": { "h": 4, "w": 6, "x": 0, "y": 0 },
      "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" },
      "targets": [{ "expr": "ss_http_uptime_seconds", "instant": true, "refId": "A" }],
      "fieldConfig": { "defaults": { "unit": "s" } }
    },
    {
      "id": 2, "type": "bargauge", "title": "Workers",
      "gridPos": { "h": 4, "w": 10, "x": 6, "y": 0 },
      "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" },
      "options": { "displayMode": "lcd" },
      "targets": [
        { "expr": "ss_http_total_workers",  "refId": "A", "legendFormat": "Total" },
        { "expr": "ss_http_workers_active", "refId": "B", "legendFormat": "Active" },
        { "expr": "ss_http_workers_idle",   "refId": "C", "legendFormat": "Idle" }
      ]
    },
    {
      "id": 3, "type": "stat", "title": "User Workers",
      "gridPos": { "h": 4, "w": 4, "x": 16, "y": 0 },
      "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" },
      "targets": [{ "expr": "ss_http_workers_user_total", "instant": true, "refId": "A" }]
    },
    {
      "id": 4, "type": "gauge", "title": "Task Workers",
      "gridPos": { "h": 4, "w": 4, "x": 20, "y": 0 },
      "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" },
      "targets": [{ "expr": "ss_http_workers_task_total", "refId": "A" }],
      "fieldConfig": { "defaults": { "min": 0 } }
    },
    {
      "id": 5, "type": "stat", "title": "Reload count",
      "gridPos": { "h": 4, "w": 6, "x": 0, "y": 4 },
      "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" },
      "targets": [{ "expr": "ss_http_reload_count", "instant": true, "refId": "A" }]
    },
    {
      "id": 6, "type": "stat", "title": "Latest reload time",
      "gridPos": { "h": 4, "w": 18, "x": 6, "y": 4 },
      "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" },
      "targets": [{ "expr": "ss_http_latest_reload_timestamp", "instant": true, "refId": "A" }],
      "fieldConfig": { "defaults": { "unit": "s" } }
    },

    { "type": "row", "title": "Main", "gridPos": { "h": 1, "w": 24, "x": 0, "y": 8 }, "collapsed": false, "id": 7 },

    {
      "id": 8, "type": "timeseries", "title": "RPM",
      "gridPos": { "h": 8, "w": 12, "x": 0, "y": 9 },
      "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" },
      "targets": [
        { "expr": "rate(ss_http_request_total[1m]) * 60", "refId": "A", "legendFormat": "requests/min" },
        { "expr": "rate(ss_http_dispatch_total[1m]) * 60", "refId": "B", "legendFormat": "dispatch/min (fallback)" }
      ],
      "fieldConfig": { "defaults": { "unit": "ops" } }
    },
    {
      "id": 9, "type": "timeseries", "title": "Coroutines Number",
      "gridPos": { "h": 8, "w": 12, "x": 12, "y": 9 },
      "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" },
      "targets": [{ "expr": "swoole_coroutines", "refId": "A", "legendFormat": "Active" }]
    },
    {
      "id": 10, "type": "timeseries", "title": "Connections",
      "gridPos": { "h": 8, "w": 12, "x": 0, "y": 17 },
      "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" },
      "targets": [
        { "expr": "increase(ss_http_accept_total[1m])", "refId": "A", "legendFormat": "Accepted/min" },
        { "expr": "increase(ss_http_close_total[1m])",  "refId": "B", "legendFormat": "Closed/min" },
        { "expr": "ss_http_connections",                 "refId": "C", "legendFormat": "Active" }
      ]
    },
    {
      "id": 11, "type": "timeseries", "title": "Memory Usage per Worker",
      "gridPos": { "h": 8, "w": 12, "x": 12, "y": 17 },
      "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" },
      "targets": [
        { "expr": "ss_http_memory_per_worker_bytes", "refId": "A", "legendFormat": "Per worker" },
        { "expr": "proc_memory_bytes",               "refId": "B", "legendFormat": "Process RSS" }
      ],
      "fieldConfig": { "defaults": { "unit": "bytes" } }
    },

    { "type": "row", "title": "HTTP details", "gridPos": { "h": 1, "w": 24, "x": 0, "y": 25 }, "collapsed": false, "id": 12 },

    {
      "id": 13, "type": "gauge", "title": "Inâ€‘flight requests",
      "gridPos": { "h": 6, "w": 6, "x": 0, "y": 26 },
      "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" },
      "targets": [{ "expr": "ss_http_requests_inflight", "refId": "A" }]
    },
    {
      "id": 14, "type": "stat", "title": "Queue size",
      "gridPos": { "h": 6, "w": 6, "x": 6, "y": 26 },
      "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" },
      "targets": [{ "expr": "ss_http_requests_queue", "instant": true, "refId": "A" }]
    },
    {
      "id": 15, "type": "timeseries", "title": "HTTP latency p95 (s)",
      "gridPos": { "h": 6, "w": 12, "x": 12, "y": 26 },
      "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" },
      "targets": [
        { "expr": "histogram_quantile(0.95, sum(rate(ss_http_request_duration_seconds_bucket[5m])) by (le))", "refId": "A", "legendFormat": "p95" }
      ],
      "fieldConfig": { "defaults": { "unit": "s" } }
    }
  ],
  "templating": { "list": [] }
}